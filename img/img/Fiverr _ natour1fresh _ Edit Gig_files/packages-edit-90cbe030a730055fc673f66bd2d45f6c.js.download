!function(e){var a,t,i,n={WRITTINGS_AND_TRANSLATIONS_CAT_ID:5},c={models:{},selectors:{$container:e(".js-gig-and-packages")},listenToGigChanges:function(){var e="gigUpcrate:gigChanged";document.addEventListener(e,function(e){var t=_.get(e.detail.gig,"categoryId");_.isNil(t)||a.init()})},init:function(){t.runOnlyOnce||(a.delegateEvents(),t.runOnlyOnce=!0),t.gigPackages&&t.gigPackages.templateData&&(t.selectedPackageCount=t.gigPackages.templateData.activePackagesCount||0),t.gigPackages=fEditGig.models.gigPackages||!1,t.isPro=fEditGig.models.isPro||!1,"packages"===t.gigPackages.mode&&a.buildModel()},delegateEvents:function(){i.$container.on("click",".try-now .activate-packages",function(e){e.preventDefault(),a.toggleMultiplePackages(!1,"user")}).on("click",".try-now .learn-more, .js-open-package-intro",function(a){a.preventDefault();var t="172455672",i="step_2_creating_triple_packages",n={page:{name:"gig_create"},gig:{id:Fiverr.models.ps.gigId}},c={title:e.t("manage_gigs.edit.packages.popup.title"),description:e.t("manage_gigs.edit.packages.popup.sub_title")};MixpanelWrapper.trackEvent(MixpanelWrapper.Events.GigUpCreateEvents.CLICKED_PRICING_VIDEO),fDashboardNew.shared.initPackagesPopup(t,i,c,n)});var t=fEditGig.models.gig_pricing,n=e(".js-toggle-multi-packages"),c=n.find("label");t.packagesCountLocked?(n.addClass(window.StandardGigsPricing.enforceClass),n.attr("title",e.t("manage_gigs.edit.gig_and_packages.standard_pricing.locked_number_of_packages"))):c.on("click",function(e){e.preventDefault(),a.toggleMultiplePackages(!1,"user")}),i.$container.on("change",a.onFieldChangeActions)},getProMinPrice:function(e){return e===n.WRITTINGS_AND_TRANSLATIONS_CAT_ID?70:100},buildModel:function(){var i,n=t.gigPackages,c=n.packages,r=t.gigPackages.default_triple_sub_cats,d=parseFloat(e('[name="gig[category_id]"]').val(),10),o=parseFloat(e('[name="gig[sub_category_id]"]').val(),10),s=r.indexOf(o)>=0?3:1,g=3===s,l=t.gigPackages.templateData={randInd:613,mode:n.mode,activePackagesCount:t.selectedPackageCount||n.active_packages_count||s,defaultTripleOnCreate:g,packages:[],subcatId:o,proMinPrice:a.getProMinPrice(d)};c&&(_.forEach(c,function(t,n){i=t,l.packages[n]={content:{}},_.forOwn(t,function(t,c){current=_.camelCase(c),"content"!==current&&("packageId"===current&&(l.packages[n].packageType=e.t("manage_gigs.edit.gig_and_packages.package_"+t)),"durationLimit"===current?l.packages[n].expectedDuration=a.fieldBuilder.expectedDuration(t,i):_.isFunction(a.fieldBuilder[current])?l.packages[n][current]=a.fieldBuilder[current](t,i):l.packages[n][current]=t)}),_.forEach(t.content,function(e,t){var i=l.packages[n].content[t]=e;switch(i.price=0,i.cssClassName=i.type.replace(/_/g,"-"),i.randInd=l.randInd,Fiverr._nullOrUndefined(i.data_value)?_.isNull(i.data_value)&&(i.dataValue=""):i.dataValue=i.data_value.toString().length&&"0"!=i.active?i.data_value:"",i.edit_type.toLowerCase()){case"dropdown":i.cssType="js-dd",i.parentType="dd-packages","modifications"===i.type?a.fieldBuilder.includedModifications(i):a.fieldBuilder.buildPricingFactorDdData(i);break;case"checkbox":i.parentType="chk-packages";break;case"input":case"text":i.cssType="js-input",i.parentType="input-packages";break;case"number":i.cssType="js-number",i.parentType="input-packages"}l.randInd++}),l.randInd+=100}),a.renderPackages())},fieldBuilder:{returnHiddenInputName:function(e,a){return"gig[packages]["+e+"]["+a+"]"},genericDDonAction:function(a){var t=e(a),i=t.data("val"),n=t.closest("td"),r=n.closest("tr").data("name"),d=n.data("package"),o=c.fieldBuilder.returnHiddenInputName(d,r),s=n.find('[name="'+o+'"]');c.updatePackageField(d,r,i,s)},expectedDuration:function(a,t){for(var i={options:[],selected:a.selected,initial:{text:e.t("manage_gigs.edit.gig_and_packages.placeholders.delivery_time")},createHiddenInput:!0,hiddenInputName:this.returnHiddenInputName(t.package_id,"duration"),selected:t.duration,onAction:this.genericDDonAction},n=a.min;n<=a.max;n++)i.options.push({text:e.t("general.num_days",{count:n})+" "+e.t("general.delivery"),val:n});return i},price:function(a,i){var n={options:[],createHiddenInput:!0,hiddenInputName:this.returnHiddenInputName(i.package_id,"price"),selected:i.price||"",initial:{text:e.t("manage_gigs.edit.gig_and_packages.placeholders.multi_price")}},c=i.price_limit.min;for(n.onAction=this.genericDDonAction,n.isPro=t.isPro;c<=i.price_limit.max;)n.options.push({val:c,text:e.i18n.numberToCurrency(c)}),c+=i.price_limit.step;return n},includedModifications:function(a){var t=c,i=t.models,n=(t.selectors,a),r="included_modifications";if(n.createHiddenInput=!1,n.onAction=function(a){var t=e(a),n=t.closest("td"),c=t.data("val"),r=parseInt(n.data("package"),10);r=i.gigPackages.templateData.packages[r-1],_.forEach(r.content,function(e,a){"modifications"===e.type&&(e.included_modifications=c)}),n.find('input[data-name="included-modifications"]').val(c).trigger("change")},_.isArray(a.included_modifications_options)){n.options=a.included_modifications_options;for(var d=0;d<n.options.length;d++)for(var o in n.options[d])n.options[d][o]=_.isString(n.options[d][o])?n.options[d][o].toLowerCase():n.options[d][o];Fiverr._nullOrUndefined(a[r])||(n.selected=a[r]),n.options.unshift({val:"select",text:e.t("general.select")})}},buildFakeDropdown:function(a,t,i){var n,r,d=c,o=(c.models,c.selectors,{autoWidth:!0,initial:{text:e.t("general.select")},maxHeight:250,showInitialOptions:!0,createHiddenInput:!0}),s=i.closest("td");t[a].options&&(n=_.extend({},o,t[a]),n.options=d.reformatDataForFakeDropdown(n.options),n.hiddenInputName&&(n.attrs='data-hidden-input-name="'+n.hiddenInputName+'"'),1===n.options.length&&(n.isDisabled=!0),"modifications"===n.type?r=Fiverr._nullOrUndefined(n.included_modifications)?"":n.included_modifications.toString():Fiverr._nullOrUndefined(n.dataValue)?Fiverr._nullOrUndefined(n.selected)||(r=n.selected):r=n.dataValue,i.fakeDropdown(n).addClass("capitalized"),!n.hasOwnProperty("active")||n.active&&0!==parseInt(n.active,10)?Fiverr._nullOrUndefined(r)||(i.fakeDropdown("val",r.toString()),d.setActiveState({$parent:s,val:"1"})):(i.fakeDropdown("reset"),d.setActiveState({$parent:s,val:"0"})))},buildSpinbox:function(a){var t=parseInt(a.data("package")),i=a.data("pf"),n=!1;i=c.getPricingFactor({factorType:i,packageId:t}),a.spinbox({onBeforeChange:function(e,a){var t=(a.closest("td"),!1);t=!Fiverr._nullOrUndefined(i.null_value)&&e==i.null_value,a.toggleClass("content-hidden",t)},forceToggleOnInitialization:!0}),a.find('input[data-field-type="data_value"]').on("change",function(){var a=e(this);n=!Fiverr._nullOrUndefined(i.null_value)&&a.val()==i.null_value,a.toggleClass("content-hidden",n)})},buildPricingFactorDdData:function(a){var t,i;if(a.createHiddenInput=!1,a.options=[],a.onAction=function(a){var t=e(a),i=t.closest("td"),n=t.data("val"),c=(parseInt(i.data("package"),10),i.data("pf"),i.find("input").filter(function(){return e(this).prop("name").indexOf("data_value")>0?!0:void 0}));c.val(n).trigger("change")},a.data_range)for(i=a.data_range.min,t=a.data_range.step||1;i<=a.data_range.max;)a.options.push({val:i.toString(),text:i}),i+=t;else a.data_options&&(a.options=a.data_options,a.options.unshift({val:"select",text:e.t("general.select")}))}},renderPackages:function(){var e=fEditGig.getCurrentServiceType(),n=_.extend(a.models.gigPackages.templateData,{standardEnforcement:window.StandardGigsPricing.enforceClass,videoThumbnail:"//assetsv2.fiverrcdn.com/assets/v2_photos/packages_video-4f6293807f749882bc033eafc7faec63.jpg"});_.isEmpty(e)||(n.serviceType=e),n.isPro=t.isPro,Fiverr._getHbTemplate({tplType:"dashboard-new",tplName:"edit-gig-and-packages",tplData:n,callback:function(e){i.$container.html(e),fPopupExamples.showExampleLinks(i.$container),a.postPackagesRenderActions(n.packages),fEditGig.initServiceType(n.serviceType)}})},postPackagesRenderActions:function(e){var n;a.toggleMultiplePackages(!0),_.forEach(e,function(t,c){_.forOwn(t,function(r,d){n=i.$container.find(".js-packages-"+_.kebabCase(d)+'[data-package="'+t.packageId+'"]'),"content"!==d&&r&&n&&n.hasClass("js-dd")&&a.fieldBuilder.buildFakeDropdown(d,e[c],n)}),_.forEach(t.content,function(e,c){n=i.$container.find(".js-packages-"+e.cssClassName+'[data-package="'+t.packageId+'"]'),n.hasClass("js-dd")?a.fieldBuilder.buildFakeDropdown(c,t.content,n):n.hasClass("js-number")&&a.fieldBuilder.buildSpinbox(n,e)})}),t.gigPackages.templateData.formInitiated=!0,fEditGig.initProPricing()},setActiveState:function(e){var a=e;a.val=a.val.toString(),a.$parent&&a.val&&a.$parent.find('input[data-name="active"]').val(a.val),a.$field&&a.val&&a.$field.val(a.val),a.model&&(a.model.active=a.val)},getSelectedSubCategoryName:function(){return e(".js-subcategories-wrapper .dropdown-toggle").text().trim()},toggleMultiplePackages:function(n,c){var r,d=t.gigPackages.templateData,o=a.getActivePackagesCount(),s=i.$container.find(".try-now"),g=(i.$container.find(".js-fake-hint-fixed"),e(".js-gig-extra")),l='input[data-name="active"], input[type="text"], textarea',p=3===o;n?(i.$pricing=i.$container.closest('section[data-name="pricing"]'),i.$packagesToggle=i.$pricing.find(".js-toggle-multi-packages"),i.$packagesToggle.removeClass("hidden")):(o=p?1:3,MixpanelWrapper.trackEvent(MixpanelWrapper.Events.GigUpCreateEvents.CLICKED_ON_PACKAGES_TOGGLE_IN_GIG_CREATE_FLOW,{"Sub-category":a.getSelectedSubCategoryName(),"Toggle Status":o}),p=!p),i.$packagesToggle.find("input").prop("checked",p),a.updateActivePackagesCount(o),p?(i.$container.find(l).attr("disabled",!1),_.delay(function(){s.addClass("hidden")},250),c&&"user"===c&&!d.defaultTripleOnCreate&&fDashboardNew.shared.initPackagesPopup(152679383,"creating_a_gig_package",null,{page:{name:"gig_create"}})):(r=d.packages[0].packageId,s.removeClass("hidden"),i.$container.find("td").filter(function(a,t){return e(t).data("package")!==r}).find(l).attr("disabled",!0)),g&&g.find(".include-check").toggleClass("hidden",!p),i.$container.toggleClass("multi-mode",p).toggleClass("single-mode",!p),s.css("opacity",p?0:1)},getAllPackages:function(){return t.gigPackages.templateData.packages},getPricingFactor:function(e){return Fiverr._nullOrUndefined(e.packageIndex)?e.packageId?(e.packageIndex=_.findIndex(t.gigPackages.templateData.packages,{packageId:e.packageId}),_.find(t.gigPackages.templateData.packages[e.packageIndex].content,{type:e.factorType})):void 0:_.find(t.gigPackages.templateData.packages[e.packageIndex].content,{type:e.factorType})},getActivePackagesCount:function(){return t.gigPackages.templateData.activePackagesCount||1},updateActivePackagesCount:function(e){var a=e||1;t.gigPackages.templateData.activePackagesCount=a,i.$container.find('input[name="gig[active_packages_count]"]').val(a).trigger("change"),_.isObject(fEditGig.models.gig_pricing)&&(fEditGig.models.gig_pricing.active_packages_count=a,fEditGig.initPackagesExtraFast(),fEditGig.renderUpgradesPerPackage()),_.forEach(t.gigPackages.templateData.packages[0].content,function(e,a){e.active&&"1"==e.active&&fEditGig.updateUpgradesPricingFactorState(e.type)})},updatePackageField:function(e,a,i,n){var c;n&&n.val(i).trigger("change"),c=_.findIndex(t.gigPackages.templateData.packages,{packageId:e}),t.gigPackages.templateData.packages[c][a]=i},onFieldChangeActions:function(i){var n=e(i.target),c=n.val(),r=n.prop("name"),d=n.closest("td"),o=parseInt(d.data("package"),10),s=d.data("pf");return"gig[active_packages_count]"===r?fGigsUpcrate.validatePackagesOnChange():void(n&&o&&(t.gigPackages.templateData.formInitiated&&d.data("touched",!0),r=_.last(_.words(r)),_.includes(["title","price","description","duration"],r)?("price"===r&&(c=parseInt(c,10)),a.updatePackageField(o,r,c)):s&&(o=_.find(t.gigPackages.templateData.packages,{packageId:o}),_.forEach(o.content,function(e,t){if(e.type===s){var i=!0;switch(n.data("field-type")&&"data_value"===n.data("field-type")&&(e.dataValue=c),Fiverr._nullOrUndefined(e.null_value)||c!=e.null_value||(i=!1),e.edit_type){case"checkbox":a.setActiveState({$field:n,val:n.prop("checked")?1:0,model:e});break;case"dropdown":a.setActiveState({$parent:n.closest("td"),val:c.toString().length&&"select"!==c?1:0,model:e});break;case"text":case"number":a.setActiveState({$parent:n.closest("td"),val:i&&c.length?1:0,model:e})}}}),fEditGig.updateUpgradesPricingFactorState(s)),fGigsUpcrate.validatePackagesOnChange()))},reformatDataForFakeDropdown:function(e){return e&&e.length&&!e[0].hasOwnProperty("val")?(_.forEach(e,function(a,t){e[t].val=a.value,e[t].attrs='data-val="'+a.value+'"'}),e):e}};window.fPackagesEdit=a=c,t=a.models,i=a.selectors,a.listenToGigChanges()}(jQuery),Handlebars.registerPartial("edit-triple-packages-price",Fiverr.Templates["dashboard-new/edit-triple-packages-price"]);